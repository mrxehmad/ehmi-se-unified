name: Build and Deploy - ehmi-se-unified
on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ID_GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Checkout Blog Branch
        run: |
          cd blog
          git fetch origin blog
          git checkout blog
          cd ..
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            portfolio/package-lock.json
            tools/package-lock.json
      
      - name: Build Portfolio
        run: |
          cd portfolio
          npm ci
          npm run build
          cd ..
      
      - name: Build Tools
        run: |
          cd tools
          npm ci
          npm run build
          cd ..
      
      - name: Create Dist Structure
        run: |
          mkdir -p dist
          
          # Copy portfolio to root
          cp -r portfolio/out/* dist/
          
          # Copy tools under /tools
          mkdir -p dist/tools
          cp -r tools/build/* dist/tools/
          
          # Copy blog under /blog
          mkdir -p dist/blog
          cp -r blog/* dist/blog/
          rm -rf dist/blog/.git dist/blog/.github
      
      - name: Deploy to Production Branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Save dist to a temporary location OUTSIDE git tracking
          echo "ðŸ“¦ Preparing deployment files..."
          mv dist /tmp/dist-deploy
          
          # Fetch production branch
          git fetch origin production 2>/dev/null || true
          
          # Switch to production branch
          git checkout -B production
          
          # Remove ALL files including hidden ones and submodule artifacts
          echo "ðŸ§¹ Cleaning production branch..."
          git rm -rf . 2>/dev/null || true
          rm -rf * .[!.]* 2>/dev/null || true
          
          # Copy dist contents from temp location to root
          echo "ðŸ“‹ Copying built files..."
          cp -r /tmp/dist-deploy/* .
          cp -r /tmp/dist-deploy/.[!.]* . 2>/dev/null || true
          
          # Cleanup temp
          rm -rf /tmp/dist-deploy
          
          # Create .nojekyll for GitHub Pages
          touch .nojekyll
          
          # Add all files
          git add -A
          
          # Commit and push
          git commit -m "Deploy $(date '+%Y-%m-%d %H:%M:%S')" || true
          git push origin production --force
          
          echo "âœ… Deployed to production branch"
