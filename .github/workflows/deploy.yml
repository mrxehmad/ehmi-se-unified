name: Build and Deploy - ehmi-se-unified

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ID_GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Checkout Blog Branch
        run: |
          cd blog
          git fetch origin blog
          git checkout blog
          cd ..
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            portfolio/package-lock.json
            tools/package-lock.json
      
      - name: Build Portfolio
        run: |
          cd portfolio
          npm ci
          npm run build
          cd ..
      
      - name: Build Tools
        run: |
          cd tools
          npm ci
          npm run build
          cd ..
      
      - name: Create Dist Structure
        run: |
          mkdir -p dist
          
          # Copy portfolio to root
          cp -r portfolio/out/* dist/
          
          # Copy tools under /tools
          mkdir -p dist/tools
          cp -r tools/build/* dist/tools/
          
          # Copy blog under /blog
          mkdir -p dist/blog
          cp -r blog/* dist/blog/
          rm -rf dist/blog/.git dist/blog/.github
      
      - name: Deploy to Production Branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git fetch origin production 2>/dev/null || true
          git checkout -B production
          
          # Clean workspace
          find . -maxdepth 1 ! -name 'dist' ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +
          
          # Move dist contents to root
          mv dist/* .
          rmdir dist
          
          # Create .nojekyll for GitHub Pages
          touch .nojekyll
          
          # Commit and push
          git add -A
          git commit -m "Deploy $(date '+%Y-%m-%d %H:%M:%S')" || true
          git push origin production --force
          
          echo "âœ… Deployed to production branch"
