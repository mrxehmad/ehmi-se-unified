# .github/workflows/deploy.yml
name: Build and Deploy Unified Site

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout with submodules
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # 2. Checkout blog submodule to 'blog' branch
      - name: Checkout Blog Branch
        run: |
          cd blog
          git fetch origin blog
          git checkout blog
          echo "âœ… Blog submodule checked out to 'blog' branch"
          echo "ğŸ“‚ Blog contents:"
          ls -la | head -20
          cd ..
      
      # 3. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            portfolio/package-lock.json
            tools/package-lock.json
      
      # 4. Build Portfolio (Next.js)
      - name: Build Portfolio
        run: |
          cd portfolio
          echo "ğŸ“¦ Installing portfolio dependencies..."
          npm ci
          echo "ğŸ”¨ Building portfolio..."
          npm run build
          echo "âœ… Portfolio build complete"
          ls -la out/
          cd ..
      
      # 5. Build Tools (React with basename="/tools")
      - name: Build Tools
        run: |
          cd tools
          echo "ğŸ“¦ Installing tools dependencies..."
          npm ci
          echo "ğŸ”¨ Building tools with PUBLIC_URL=/tools..."
          PUBLIC_URL=/tools npm run build
          echo "âœ… Tools build complete"
          ls -la build/
          cd ..
      
      # 6. Merge everything into dist/
      - name: Merge Builds
        run: |
          echo "ğŸ—‚ï¸ Creating dist directory..."
          mkdir -p dist
          
          echo ""
          echo "ğŸ“‹ Step 1: Copy Portfolio (base layer)"
          cp -r portfolio/out/* dist/
          echo "  âœ“ Portfolio copied to dist/"
          
          echo ""
          echo "ğŸ”§ Step 2: Add Tools under /tools"
          mkdir -p dist/tools
          cp -r tools/build/* dist/tools/
          echo "  âœ“ Tools copied to dist/tools/"
          
          echo ""
          echo "ğŸ“ Step 3: Add Blog - Everything under /blog"
          mkdir -p dist/blog
          
          # Copy ALL blog files to /blog directory
          echo "  ğŸ“„ Copying all blog files to /blog/..."
          cp -r blog/* dist/blog/
          
          # Remove .git directory if present
          rm -rf dist/blog/.git 2>/dev/null || true
          rm -rf dist/blog/.github 2>/dev/null || true
          
          echo "  âœ“ Blog copied to dist/blog/"
          echo "  âœ“ Blog structure:"
          ls -la dist/blog/ | head -15
          
          echo ""
          echo "ğŸ”— Step 4: Create unified configuration files"
          
          # Create unified robots.txt
          cat > dist/robots.txt << 'EOF'
User-agent: *
Allow: /

# Section sitemaps
Sitemap: https://ehmi.se/sitemap.xml
Sitemap: https://ehmi.se/tools/sitemap.xml
Sitemap: https://ehmi.se/blog/sitemap.xml
EOF
          echo "  âœ“ Created unified robots.txt"
          
          # Create _redirects for SPA routing and subdomain redirects
          cat > dist/_redirects << 'EOF'
# Redirect old blog subdomain to new location
https://blog.ehmi.se/*  https://ehmi.se/blog/:splat  301!

# Redirect old tools subdomain  
https://tools.ehmi.se/*  https://ehmi.se/tools/:splat  301!

# SPA fallback for tools (must be last)
/tools/*  /tools/index.html  200
EOF
          echo "  âœ“ Created _redirects for hosting"
          
          echo ""
          echo "âœ… Build merge complete!"
          echo ""
          echo "ğŸ“Š Final structure:"
          echo "dist/"
          echo "â”œâ”€â”€ index.html (portfolio)"
          echo "â”œâ”€â”€ about.html"
          echo "â”œâ”€â”€ contact.html"
          echo "â”œâ”€â”€ ..."
          echo "â”œâ”€â”€ tools/"
          echo "â”‚   â”œâ”€â”€ index.html"
          echo "â”‚   â”œâ”€â”€ static/"
          echo "â”‚   â””â”€â”€ ..."
          echo "â””â”€â”€ blog/"
          echo "    â”œâ”€â”€ index.html"
          echo "    â”œâ”€â”€ some-article/"
          echo "    â”œâ”€â”€ another-article/"
          echo "    â””â”€â”€ ..."
          
          echo ""
          echo "ğŸ“ˆ Directory sizes:"
          du -sh dist/* 2>/dev/null | sort -hr | head -10
      
      # 7. Push source code to production branch
      - name: Deploy to Production Branch
        run: |
          echo "ğŸš€ Preparing deployment to production branch..."
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Checkout/create production branch
          git fetch origin production 2>/dev/null || true
          git checkout -B production
          
          # Remove everything except dist/ and .git
          echo "ğŸ§¹ Cleaning workspace..."
          find . -maxdepth 1 ! -name 'dist' ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # Move dist contents to root
          echo "ğŸ“¦ Moving built files to root..."
          mv dist/* . 2>/dev/null || true
          mv dist/.* . 2>/dev/null || true
          rmdir dist 2>/dev/null || true
          
          # Create .nojekyll for GitHub Pages compatibility
          touch .nojekyll
                    
          # Add all files
          git add -A
          
          # Commit with detailed message
          COMMIT_MSG="ğŸš€ Deploy: $(date '+%Y-%m-%d %H:%M:%S')

Deployed from commit: ${GITHUB_SHA:0:7}
Workflow run: #${GITHUB_RUN_NUMBER}
Trigger: Manual deployment
          
Components:
âœ“ Portfolio (Next.js static export)
âœ“ Tools (React SPA under /tools/)
âœ“ Blog (Publii CMS under /blog/)"
          
          git diff --staged --quiet || git commit -m "$COMMIT_MSG"
          
          # Push to production
          echo "ğŸ“¤ Pushing to production branch..."
          git push origin production --force
          
          echo "âœ… Deployment complete!"
          echo "ğŸŒ Site pushed to production branch"
      
      # 8. Summary
      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Built components:"
          echo "  âœ“ Portfolio (Next.js) â†’ /"
          echo "  âœ“ Tools (React) â†’ /tools/"
          echo "  âœ“ Blog (Publii) â†’ /blog/"
          echo ""
          echo "ğŸŒ Deployment target:"
          echo "  Branch: production"
          echo "  Repository: ${{ github.repository }}"
          echo ""
          echo "ğŸ”— Next steps:"
          echo "  1. Configure Cloudflare Pages:"
          echo "     - Production branch: production"
          echo "     - Build command: (none - already built)"
          echo "     - Build output: / (root)"
          echo "  2. Set custom domain: ehmi.se"
          echo "  3. Test URLs:"
          echo "     âœ“ https://ehmi.se/"
          echo "     âœ“ https://ehmi.se/tools/"
          echo "     âœ“ https://ehmi.se/blog/"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
